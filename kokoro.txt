# speech dispatcher
paru -S uv
# install kokoro-tts with
uv tool install kokoro-tts

mkdir .local/share/kokoro
cd .local/share/kokoro

# Download voice data (bin format is preferred)
wget https://github.com/nazdridoy/kokoro-tts/releases/download/v1.0.0/voices-v1.0.bin

# Download the model
wget https://github.com/nazdridoy/kokoro-tts/releases/download/v1.0.0/kokoro-v1.0.onnx

cd

mkdir .config/speech-dispatcher

nano speechd.conf (in speech-dispatcher)
###
### THIS CONFIG WAS GENERATED BY PIED
###

SymbolsPreproc "char"
SymbolsPreprocFile "gender-neutral.dic"
SymbolsPreprocFile "font-variants.dic"
SymbolsPreprocFile "symbols.dic"
SymbolsPreprocFile "emojis.dic"
SymbolsPreprocFile "orca.dic"
SymbolsPreprocFile "orca-chars.dic"
AddModule "piper" "sd_generic" "piper.conf"
AddModule "kokoro" "sd_generic" "kokoro.conf"
DefaultModule kokoro
Include "clients/*.conf"

mkdir .config/speech-dispatcher/modules

nano modules/kokoro.conf
# ~/.config/speech-dispatcher/modules/kokoro.conf

GenericExecuteSynth "if command -v sox > /dev/null; then\
        PROCESS='sox -t raw -r 22050 -b 16 -e signed -c 1 - -t wav - tempo $RATE pitch $PITCH norm';\
        if command -v paplay > /dev/null; then\
            OUTPUT='paplay';\
        else\
            OUTPUT='aplay -q';\
        fi;\
    elif command -v paplay > /dev/null; then\
        PROCESS='cat'; OUTPUT='paplay --raw --channels 1 --rate 22050 --format=s16le';\
    else\
        PROCESS='cat'; OUTPUT='aplay -q -t raw -c 1 -r 22050 -f S16_LE';\
    fi;\
    printf \"%s\" \"$DATA\" \
    | /home/jakob/.venv/bin/kokoro-tts - --stream --voice af_sarah \
        --model /home/jakob/.local/share/kokoro/kokoro-v1.0.onnx \
        --voices /home/jakob/.local/share/kokoro/voices-v1.0.bin 2>/dev/null \
    | $PROCESS \
    | $OUTPUT - ; exit 0"

# Map SPD rate/pitch/volume variables (same as your piper.conf)
GenericRateAdd 1
GenericPitchAdd 1
GenericVolumeAdd 1
GenericRateMultiply 1
GenericPitchMultiply 1000

# Optional: expose a named voice entry (just cosmetic)
AddVoice "en_US" "FEMALE1" "Kokoro"
